<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>도서 관리 시스템</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="container mt-4">
    <h2>📚 도서 관리 시스템</h2>

    <!-- 알림 메시지 표시 -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <div class="card">
        <!-- 로그인/로그아웃 헤더 -->
        <div th:if="${not #authorization.expression('isAuthenticated()')}"
             class="card-header d-flex justify-content-center align-items-center">
            <form class="form-inline" th:action="@{/login}" method="post">
                <label for="username">Username:</label>
                <input type="text" class="form-control ml-2" placeholder="Enter username"
                       id="username" name="username">
                <label for="password" class="ml-3">Password:</label>
                <input type="password" class="form-control ml-2" placeholder="Enter password"
                       id="password" name="password">
                <button type="submit" class="btn btn-primary btn-sm ml-3">로그인</button>
            </form>
            <div class="mx-2">
                <a th:href="@{/register}" class="btn btn-sm btn-secondary">회원가입</a>
            </div>
        </div>

        <div th:if="${#authorization.expression('isAuthenticated()')}"
             class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <p class="mb-0">
                    👤 로그인: <strong th:text="${#authentication.principal.member.name}"></strong>
                    <span class="badge badge-info ml-2"
                          th:each="role : ${#authentication.authorities}"
                          th:text="${role.authority.replace('ROLE_', '')}"></span>
                </p>
            </div>
            <div>
                <a th:href="@{/book/mybooks}" class="btn btn-info btn-sm">내 책 목록</a>
                <a th:href="@{/logout}" class="btn btn-danger btn-sm ml-2">로그아웃</a>
                <a sec:authorize="hasAuthority('ROLE_ADMIN')"
                   th:href="@{/member/admin}" class="btn btn-warning btn-sm ml-2">관리자</a>
            </div>
        </div>

        <div class="card-body">
            <!-- 책 검색 영역 -->
            <div class="mb-3">
                <form class="form-inline" th:action="@{/book/search}" method="get">
                    <input type="text" class="form-control mr-2" name="title"
                           placeholder="책 제목으로 검색...">
                    <button type="submit" class="btn btn-outline-primary btn-sm">🔍 검색</button>
                </form>
            </div>

            <!-- 책 목록 테이블 -->
            <table class="table table-hover">
                <thead class="thead-light">
                <tr>
                    <th width="5%">번호</th>
                    <th width="30%">제목</th>
                    <th width="15%">저자</th>
                    <th width="12%">가격</th>
                    <th width="8%">페이지</th>
                    <th width="12%">등록자</th>
                    <th width="10%">등록일</th>
                    <th width="8%">관리</th>
                </tr>
                </thead>
                <tbody>
                <!-- 책 목록이 없을 때 -->
                <tr th:if="${books == null or books.empty}">
                    <td colspan="8" class="text-center text-muted">
                        등록된 책이 없습니다. 첫 번째 책을 등록해보세요!
                    </td>
                </tr>

                <!-- 책 목록 표시 -->
                <tr th:each="book, iterStat : ${books}">
                    <td th:text="${iterStat.count}"></td>
                    <td>
                        <a th:href="@{/book/detail/{id}(id=${book.id})}"
                           th:text="${book.title}"
                           class="text-decoration-none"></a>
                    </td>
                    <td th:text="${book.author}"></td>
                    <td>
                        <span th:text="${#numbers.formatInteger(book.price, 1, 'COMMA')}"></span>원
                    </td>
                    <td th:text="${book.page + 'p'}"></td>
                    <td>
                        <small th:text="${book.registeredBy?.name ?: '알 수 없음'}"></small>
                    </td>
                    <td>
                        <small th:text="${#temporals.format(book.createdAt, 'MM/dd')}"></small>
                    </td>
                    <td>
                        <!-- 본인이 등록한 책이거나 관리자인 경우 수정/삭제 버튼 표시 -->
                        <div class="btn-group btn-group-sm" role="group"
                             th:if="${#authorization.expression('isAuthenticated()') and
                                        (book.registeredBy?.username == #authentication.name or
                                         #authorization.expression('hasRole(''ADMIN'')'))}">
                            <a th:href="@{/book/edit/{id}(id=${book.id})}"
                               class="btn btn-outline-primary btn-sm">수정</a>
                            <form th:action="@{/book/delete/{id}(id=${book.id})}"
                                  method="post" style="display: inline;"
                                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm">삭제</button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- 책 등록 버튼 (로그인한 사용자만) -->
            <div class="text-right">
                <a th:if="${#authorization.expression('isAuthenticated()')}"
                   th:href="@{/book/register}" class="btn btn-primary">
                    📖 새 책 등록
                </a>
            </div>
        </div>

        <div class="card-footer text-muted">
            <small>Spring Boot + Spring Security 도서 관리 시스템</small>
        </div>
    </div>
</div>

</body>
</html>